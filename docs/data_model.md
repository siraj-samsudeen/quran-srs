## Production Database Schema (Current State)

This reflects the actual structure of `data/quran_v10.db` in production use.

### Conventions
- All tables have autogenerated primary key `id`  
- Table names are plural: users, hafizs, etc.
- Foreign keys follow format: user_id, hafiz_id
- Text fields store dates as strings (SQLite format)
- Boolean fields stored as INTEGER (0/1)

## Current Tables (15 total)

### User Management

**Multi-user architecture supporting family/teaching scenarios:**
- Single user manages multiple hafiz profiles (Fatima manages her 3 children plus herself)
- Independent access with cross-permissions (Zainab manages herself + helps siblings)
- Shared access scenarios (both parents access child's account)

#### users
Account holders who can log in and access the system.
```sql
CREATE TABLE [users] (
   [id] INTEGER PRIMARY KEY,
   [name] TEXT,
   [email] TEXT,
   [password] TEXT,
   [role] TEXT
);
```

#### hafizs  
Individual memorizers whose progress is tracked.
```sql
CREATE TABLE [hafizs] (
   [id] INTEGER PRIMARY KEY,
   [name] TEXT,
   [age_group] TEXT,
   [daily_capacity] INTEGER,
   [current_date] TEXT,        -- Day management feature
   [display_count] INTEGER DEFAULT 5  -- UI preference
);
```

#### hafizs_users
Many-to-many relationship between users and hafizs.
```sql
CREATE TABLE hafizs_users (
    id INTEGER PRIMARY KEY, 
    user_id INTEGER REFERENCES users (id), 
    hafiz_id INTEGER REFERENCES hafizs (id), 
    relationship TEXT,  -- self, parent, teacher, sibling
    granted_by_user_id INTEGER, 
    granted_at TEXT
);
```

### Quran Content Structure

#### mushafs
Different versions/editions of the Quran with their layout specifications.
```sql
CREATE TABLE [mushafs] (
   [id] INTEGER PRIMARY KEY,
   [name] TEXT,
   [description] TEXT,
   [total_pages] INTEGER,
   [lines_per_page] INTEGER
);
```

#### surahs  
Surahs of the Quran (1-114).
```sql
CREATE TABLE [surahs] (
   [id] INTEGER PRIMARY KEY,
   [number] INTEGER,
   [name] TEXT,
   [total_ayat] INTEGER
);
```

#### pages
Individual pages within a mushaf.
```sql
CREATE TABLE pages (
    id              INTEGER PRIMARY KEY,
    mushaf_id       INTEGER REFERENCES mushafs (id),
    page_number     INTEGER,
    juz_number      INTEGER,
    start_text      TEXT,
    starting_verse  TEXT,
    ending_verse    TEXT,
    multiple_surahs INTEGER  -- Boolean flag
);
```

#### items
**The memorization unit** - can be page, page-part, or surah-based tracking.
```sql
CREATE TABLE items (
    id INTEGER PRIMARY KEY, 
    item_type TEXT,  -- page, page-part, surah
    surah_id INTEGER REFERENCES surahs (id), 
    surah_name TEXT, 
    page_id INTEGER REFERENCES pages (id), 
    part TEXT,       -- "Part 1", "Top part", etc.
    start_text TEXT, 
    lines TEXT, 
    part_type TEXT, 
    hafiz_id INTEGER REFERENCES hafizs (id),  -- Personalized items
    active INTEGER,  -- Boolean flag
    description TEXT
);
```

### Revision System

#### modes
**Production Data:** 5 modes with specific numbering system
```sql
CREATE TABLE [modes] (
   [id] INTEGER PRIMARY KEY,
   [name] TEXT,
   [description] TEXT
);
```
**Current modes:**
- 1: "0. Full cycle" (monthly reps) âœ… **Fully implemented**
- 2: "5. New Memorization" âœ… **Fully implemented** 
- 3: "1. Daily Reps" âœ… **Implemented but hard-coded**
- 4: "2. Weekly Reps" âœ… **Implemented but hard-coded**  
- 5: "4. SRS - Variable Reps" ðŸ”¶ **Basic implementation**

#### statuses
Current memorization states.
```sql
CREATE TABLE statuses (
    id     INTEGER PRIMARY KEY,
    name TEXT,
    description TEXT
);
```
**Current statuses:** Strong, Weakened, Forgotten, New Memorization, SRS Mode, Not Started

#### revisions
All revision entries with SRS interval tracking.
```sql
CREATE TABLE revisions (
    id INTEGER PRIMARY KEY, 
    hafiz_id INTEGER REFERENCES hafizs (id), 
    item_id INTEGER REFERENCES items (id), 
    revision_date TEXT, 
    rating INTEGER,  -- -1(Bad), 0(Ok), 1(Good)
    mode_id INTEGER REFERENCES modes (id), 
    plan_id INTEGER REFERENCES plans (id), 
    notes TEXT, 
    last_interval INTEGER,     -- SRS tracking
    current_interval INTEGER,  -- SRS tracking  
    next_interval INTEGER      -- SRS tracking
);
```

#### hafizs_items  
**Core table:** Current status and statistics for each hafiz-item pair.
```sql  
CREATE TABLE hafizs_items (
    id INTEGER PRIMARY KEY, 
    hafiz_id INTEGER REFERENCES hafizs (id), 
    item_id INTEGER REFERENCES items (id), 
    page_number INTEGER, 
    mode_id INTEGER REFERENCES modes (id), 
    next_review TEXT,           -- Scheduling
    last_review TEXT,           -- Scheduling
    watch_list_graduation_date TEXT,  -- Weekly reps graduation
    srs_booster_pack_id INTEGER REFERENCES srs_booster_pack(id),
    booster_pack_id INTEGER REFERENCES booster_packs(id),
    srs_start_date TEXT,        -- SRS mode entry date
    -- Statistics
    good_streak INTEGER, 
    bad_streak INTEGER, 
    good_count INTEGER, 
    bad_count INTEGER, 
    score INTEGER,              -- Sum of ratings
    count INTEGER,              -- Total reviews
    -- SRS intervals
    last_interval INTEGER, 
    current_interval INTEGER, 
    next_interval INTEGER,
    status_id INTEGER REFERENCES statuses(id)
);
```

#### plans
Full cycle (monthly reps) tracking - **fully implemented**
```sql
CREATE TABLE plans (
    id INTEGER PRIMARY KEY, 
    hafiz_id INTEGER REFERENCES hafizs (id), 
    start_date TEXT, 
    end_date TEXT, 
    start_page INTEGER, 
    end_page INTEGER, 
    revision_count INTEGER, 
    page_count INTEGER, 
    completed INTEGER  -- Boolean
);
```

### Booster Pack System

#### booster_packs
**Daily/Weekly repetition configurations** - currently hard-coded but designed to be configurable.
```sql
CREATE TABLE booster_packs(
    id                INTEGER PRIMARY KEY,
    name              TEXT,
    description       TEXT,
    daily_reps        INTEGER,
    weekly_reps       INTEGER
);
```
**Current booster packs:**
- Quick Booster: 3 daily + 3 weekly revisions
- Standard Booster: 5 daily + 5 weekly revisions  
- Full Booster: 7 daily + 7 weekly revisions (like new memorization)

#### srs_booster_pack
**SRS interval sequence configurations** - defines spaced repetition patterns.
```sql
CREATE TABLE srs_booster_pack (
    id                INTEGER PRIMARY KEY,
    name              TEXT,
    description       TEXT,
    start_interval      INTEGER,    -- Days to start sequence
    end_interval      INTEGER,      -- Total days in sequence
    interval_days     TEXT          -- Comma-separated day sequence
);
```
**Current SRS patterns:**
- Standard SRS: 30-day cycle with prime number intervals
- Relaxed SRS: 45-day cycle, more practical
- Extended SRS: 60-day cycle, extra reinforcement  
- Long-term SRS: 90-day cycle for very difficult pages

## Data Migration Considerations

### SQLite to PostgreSQL Changes Required
1. **Date fields**: TEXT â†’ DATE/TIMESTAMP types
2. **Boolean fields**: INTEGER (0/1) â†’ BOOLEAN  
3. **Primary keys**: INTEGER â†’ SERIAL/BIGSERIAL
4. **Comma-separated values**: `interval_days` TEXT â†’ Array or separate table
5. **Foreign key constraints**: Add proper CASCADE options

### Data Preservation Priority
- **All 15 tables** must migrate with zero data loss
- **Foreign key relationships** must be maintained exactly
- **Existing hafiz progress** and revision history critical
- **SRS interval sequences** need special handling (CSV to array/JSON)

### Migration Order
1. **Static data**: mushafs, surahs, pages, modes, statuses, booster_packs, srs_booster_pack
2. **User data**: users, hafizs, hafizs_users  
3. **Content data**: items (depends on hafizs)
4. **Tracking data**: plans, hafizs_items, revisions (depends on all above)

## Current Feature Status

### âœ… Fully Working (High Priority Migration)
- **Full cycle (monthly reps)**: Complete implementation with plans table
- **User/hafiz management**: Multi-user architecture working
- **New memorization tracking**: Complete workflow
- **Basic authentication**: Login/logout functionality
- **Day management**: current_date tracking in hafizs

### ðŸ”¶ Working but Needs Enhancement (Phase 2)
- **Daily/weekly reps**: Hard-coded, needs booster pack integration
- **SRS mode**: Basic implementation, needs algorithm refinement
- **Day planning/closing**: Exists but needs UI/UX improvements

### ðŸ“‹ Enhancement Opportunities (Phase 3)
- **Fortnightly reps**: Missing mode (would be ID 3)
- **Monthly reps option**: Additional booster pack configuration
- **Enhanced day planning**: Future page pulling, skip functionality
- **Improved SRS graduation**: Better day closing workflow
